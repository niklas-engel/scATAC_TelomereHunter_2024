---
title: "Quantifying immune cell telomere content at single-cell resolution in context of PD-1 checkpoint immunotherapy"
author: "Niklas Engel"
date: "2024-07-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data Preparation

Start with loading the required packages, global options and style templates

```{r}
# load packages 
library(readr)
library(tidyverse)
library(ggpointdensity)
library(gridExtra)
library(ggExtra)
library(ggpmisc)
library(ggrepel)
library(ggpubr)
library(gplots)
library(cowplot)
library(tidyr)
library(rstatix)
library(reshape2)
library(Seurat)
library(scales)
library(BiocompR)
library(ggtext)
library(umap)
library(viridis)
library(RColorBrewer)

# disable scientific notation
options(scipen=1000000)

# style templates
theme_publication <- 
  theme_bw() +
  theme(axis.line = element_line(color='black'),
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.text.x = element_text(vjust = 1, hjust=0.5, size = 15),  
        axis.text.y = element_text(size = 15),
        axis.title = element_text(size = 20),
        strip.text.x = element_text(size = 15),
        strip.text.y = element_text(size = 15),
        legend.text = element_text(size = 15),
        legend.title = element_text(size = 20))

scale_fill_publication <- function(...){
  library(scales)
  discrete_scale("fill","Publication",manual_pal(values = c("#386cb0","#fdb462","#7fc97f","#ef3b2c","#662506","#a6cee3","#fb9a99","#984ea3","#ffff33")), ...)
  
}

scale_colour_publication <- function(...){
  library(scales)
  discrete_scale("colour","Publication",manual_pal(values = c("#386cb0","#fdb462","#7fc97f","#ef3b2c","#662506","#a6cee3","#fb9a99","#984ea3","#ffff33")), ...)
  
}

scale_colour_20 <- function(...){
  library(scales)
  discrete_scale("colour","Publication",manual_pal(values = c('#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe', '#008080', '#e6beff', '#9a6324', '#fffac8', '#800000', '#aaffc3', '#808000', '#ffd8b1', '#000075', '#808080', '#ffffff', '#000000')), ...)
  
}

scale_fill_20 <- function(...){
  library(scales)
  discrete_scale("fill","Publication",manual_pal(values = c('#e6194b', '#3cb44b', '#ffe119', '#4363d8', '#f58231', '#911eb4', '#46f0f0', '#f032e6', '#bcf60c', '#fabebe', '#008080', '#e6beff', '#9a6324', '#fffac8', '#800000', '#aaffc3', '#808000', '#ffd8b1', '#000075', '#808080', '#ffffff', '#000000')), ...)
  
}

```

# Figure 1: Analysis of progressive removal of low coverage cells from analysis

```{r}
# load the required table with telomere content calculations from TelomereHunter
masterdataframe_tanno <- read_csv("../data/masterdataframe_tanno_satpathy.csv")
masterdataframe_tanno$pre_post_f = factor(masterdataframe_tanno$pre_post, levels=c('pre treatment','post treatment'))

# compute "raw telomere content" or telomeric reads per million sequenced reads (TRPM)
masterdataframe_tanno$trpm <- masterdataframe_tanno$tel_reads*1000000/masterdataframe_tanno$total_reads

# keep only cells with a minimum of 10^4 total reads
masterdataframe_tanno_t4 <- subset(masterdataframe_tanno, seq_depth >= 4)

# create subsets of the original data frame by increasing total reads cutoffs 
masterdataframe_tanno_rounded <- masterdataframe_tanno
masterdataframe_tanno_rounded$seq_depth <- round(masterdataframe_tanno_rounded$seq_depth, digits = 1)
masterlist <- list()
sapply(seq(1,27), function(x){
  masterlist[[x]] <<- subset(masterdataframe_tanno_rounded, seq_depth >= c(0,seq(3, 5.5, 0.1))[x])
})
names(masterlist) <- c(0, seq(3,5.5,0.1))
masterdataframe_thresholds <- bind_rows(masterlist, .id = "threshold")

# get the telomere content median and standard deviation for the different T-cell subtypes 
threshold_cell_subtype_stats <- masterdataframe_thresholds %>%
  group_by(Satpathy_T_cell_annot, threshold) %>%
  summarize(Median = median(tel_content), SD = sd(tel_content))

threshold_cell_subtype_stats$threshold <- 10^as.numeric(threshold_cell_subtype_stats$threshold)

threshold_sums <- data.frame(table(masterdataframe_thresholds$threshold))
threshold_sums$percentage <- as.numeric(as.character(threshold_sums$Freq)) / max(threshold_sums$Freq)

threshold_sums$stadev <- masterdataframe_thresholds %>%
  group_by(threshold) %>%
  summarise(sd(tel_content))
threshold_sums$sd <- threshold_sums$stadev$`sd(tel_content)`
threshold_sums$stadev <- NULL

threshold_sums$med <- masterdataframe_thresholds %>%
  group_by(threshold) %>%
  summarise(median(tel_content))
threshold_sums$median <- threshold_sums$med$`median(tel_content)`
threshold_sums$med <- NULL

threshold_sums$null <- masterdataframe_thresholds %>%
  group_by(threshold) %>%
  summarize(total_count = n(), 
            zero_count = sum(tel_content == 0), 
            zero_percent = zero_count/total_count)
threshold_sums$zeros <- threshold_sums$null$zero_percent
threshold_sums$null <- NULL

threshold_sums$Var1 <- as.character(threshold_sums$Var1)
threshold_sums$Var1 <- 10^as.numeric(threshold_sums$Var1)

# generate the figures
A1 <- ggplot(masterdataframe_tanno, aes(total_reads)) +
  geom_histogram(bins = 100) +
  geom_vline(xintercept = 10000, color = "red") +
  theme_publication +
  labs(x = "Total reads") +
  scale_x_log10(breaks = c(1000, 10000, 100000, 1000000)) +
  annotation_logticks(side = "b")

B1 <- ggplot(threshold_sums, aes(factor(Var1), zeros*100, group = 1)) + 
  geom_line(size = 1) +
  geom_vline(xintercept = factor(10000), color = "red") +
  theme_publication +
  scale_x_discrete(labels = c("", "1000", rep("", 9), "10000", rep("", 9), "100000", rep("", 5))) +
  labs(x = "Total reads cutoff", y = "Telomere content zero ratio [%]")

C1 <- ggplot(threshold_cell_subtype_stats, aes(factor(threshold), Median, col = factor(Satpathy_T_cell_annot), group = Satpathy_T_cell_annot)) +
  geom_line() +
  geom_vline(xintercept = factor(10000), color = "red") +
  scale_colour_20() +
  theme_publication +
  labs(col = "T-cell subtype", y = "Median telomere content", x = "Total reads cutoff") +
  scale_x_discrete(labels = c("", "1000", rep("", 9), "10000", rep("", 9), "100000", rep("", 5))) +
  theme(legend.position = "none")

# generate the multipanel figure 
FIG1 = plot_grid(
  plot_grid(
    A1, B1, 
    nrow = 1, labels = c("a", "b"), label_size = 25), 
  plot_grid(
    C1, get_legend(C1 + theme(legend.position = "right")), 
    labels = c("c", ""), label_size = 25, nrow = 1, rel_widths = c(.8, .2)), 
  nrow = 2, align = "hv")

# save the figure
ggsave(filename = "path/figure_1.pdf", plot = FIG1, units = "in", width = 16, height = 14)
ggsave(filename = "path/figure_1.png", plot = FIG1, units = "in", width = 16, height = 14)

```

# Figure 2: Comparison of TRPM estimates from TelomereHunter to in vivo studies

```{r}
# generate the TRPM boxplots
A2 <- ggplot(masterdataframe_tanno_t4, aes(cell_type, trpm)) +
  geom_boxplot() +
  # mark in vivo validates regions
  geom_hline(yintercept = 200, color = "red") +
  geom_hline(yintercept = 1000, color = "red") +
  scale_y_log10() +
  theme_publication +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust= 1)) +
  labs(y = "Telomeric reads [TRPM]", x = "Cell type")

B2 <- ggplot(masterdataframe_tanno_t4, aes(sampleID, trpm, fill = responder)) +
  geom_boxplot() +
  theme_publication +
  scale_fill_manual(values = c("#4393C3", "#D6604D")) +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust= 1), 
        legend.position = "none") +
  scale_y_log10() +
  geom_hline(yintercept = 200, color = "red") +
  geom_hline(yintercept = 1000, color = "red") +
  labs(y = "", x = "SampleID", fill = "Response")

C2 <- ggplot(masterdataframe_tanno_t4, aes(Satpathy_T_cell_annot, trpm)) +
  geom_boxplot() +
  theme_publication +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust= 1)) +
  scale_y_log10() +
  geom_hline(yintercept = 200, color = "red") +
  geom_hline(yintercept = 1000, color = "red") +
  labs(y = "", x = "T-cell subtype")

# set all three plots to the same y axis breaks 
A2 <- A2 + scale_y_log10(breaks = c(10, 100, seq(200, 1000, 200), 10000))
B2 <- B2 + scale_y_log10(breaks = c(10, 100, seq(200, 1000, 200), 10000))
C2 <- C2 + scale_y_log10(breaks = c(10, 100, seq(200, 1000, 200), 10000))

# generate the multipanel figure 
FIG2 = plot_grid(
  plot_grid(
    A2, B2, C2, 
    nrow = 1, ncol = 3, labels = c("a", "b", "c"), rel_widths = c(.2, .4, .4), align = "hv", label_size = 25),
  plot_grid(
    get_legend(B2 + theme(legend.position = "bottom"))), 
  nrow = 2, rel_heights = c(.95, .05))

# save the figure
ggsave(filename = "path/figure_2.pdf", plot = FIG2, units = "in", width = 16, height = 10)
ggsave(filename = "path/figure_2.png", plot = FIG2, units = "in", width = 16, height = 10)

```

# Figure 3: Projection of telomere content on a single-cell level

```{r}
# calculate unnormalized counts of T-cell subtypes per patientID pre- and post-treatment
unnormalized_counts <- masterdataframe_tanno_t4 %>%
  group_by(patientID, Satpathy_T_cell_annot, pre_post) %>%
  summarise(count = n(), median(tel_content))

# calculate normalized counts
normalized_counts <- unnormalized_counts %>%
  group_by(patientID, pre_post) %>%
  mutate(total = sum(count)) %>%
  mutate(normalized_count = count*100 / total) %>%
  ungroup()

normalized_counts$patientID <- factor(normalized_counts$patientID)

# subset the pre- and post-treatment counts and calculate their differences 
pre <- subset(normalized_counts, pre_post == "pre treatment")
post <- subset(normalized_counts, pre_post == "post treatment")

diff_data <- merge(pre, post, by = c("patientID", "Satpathy_T_cell_annot"), all = TRUE)
diff_data$count_diff <- diff_data$count.y - diff_data$count.x
diff_data$count_diff_normalized <- diff_data$normalized_count.y - diff_data$normalized_count.x
diff_data$tel_diff <- diff_data$`median(tel_content).y` - diff_data$`median(tel_content).x`
diff_data$count_diff_percentage <- ((diff_data$count.y - diff_data$count.x) / diff_data$count.x) * 100

# load the UMAP data
harmony_umap <- readRDS("../data/harmony_umap.rds")

# merge the UMAP data with the masterdataframe 
masterdataframe_tanno_t4_umap <- merge(masterdataframe_tanno_t4, harmony_umap, by = "barcode")
colnames(masterdataframe_tanno_t4_umap) <- make.unique(names(masterdataframe_tanno_t4_umap))

# round the UMAP coordinates for better visibility of differences in telomere content on a single-cell level
masterdataframe_tanno_t4_umap_rounded <- masterdataframe_tanno_t4_umap
masterdataframe_tanno_t4_umap_rounded <- masterdataframe_tanno_t4_umap_rounded %>%
  group_by(pre_post_f, responder) %>%
  summarise(umap1 = round(umap_harmony_1, digits = 1), umap2 = round(umap_harmony_2, digits = 1), tel_content)

masterdataframe_tanno_t4_umap_rounded$cood_id <- paste(masterdataframe_tanno_t4_umap_rounded$umap1, masterdataframe_tanno_t4_umap_rounded$umap2, sep = "_")

# compute the median, mean, minimum and maximum telomere content of all cells that share the same coordinates after rounding
masterdataframe_tanno_t4_umap_rounded_stats = masterdataframe_tanno_t4_umap_rounded %>%
  group_by(pre_post_f, responder, cood_id) %>%
  summarise(median_tel = median(tel_content), mean_tel = mean(tel_content), min_tel = min(tel_content), max_tel = max(tel_content)) %>%
  separate(cood_id, into = c("umap1", "umap2"), sep = "_")

masterdataframe_tanno_t4_umap_rounded_stats$umap1 <- as.numeric(masterdataframe_tanno_t4_umap_rounded_stats$umap1)
masterdataframe_tanno_t4_umap_rounded_stats$umap2 <- as.numeric(masterdataframe_tanno_t4_umap_rounded_stats$umap2)

# generate the figures 
A3 <- masterdataframe_tanno_t4_umap_rounded_stats %>%
  ggplot(aes(umap1, umap2, col = mean_tel)) +
  geom_point() +
  facet_grid(pre_post_f~responder) +
  scale_color_viridis(option = "plasma", limits = c(0, 25000), oob = scales::squish) +
  labs(col = "Mean telomere content") +
  theme_publication +
  theme(plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background =element_rect(fill="white"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank(),
        panel.border = element_blank()
        )

B3 <- masterdataframe_tanno_t4_umap %>%
  ggplot(aes(umap_harmony_1, umap_harmony_2, col = Satpathy_T_cell_annot)) +
  geom_point() +
  facet_grid(pre_post_f~responder) +
  scale_colour_20() +
  labs(col = "T-cell subtype") +
  theme_publication +
  theme(plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background =element_rect(fill="white"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank(),
        panel.border = element_blank()
  )

C3 <- ggplot(subset(diff_data, patientID == "SU009"), aes(tel_diff, count_diff_percentage, col = Satpathy_T_cell_annot)) +
  geom_point(size = 3) +
  scale_x_continuous(limits = symmetric_limits) +
  scale_y_continuous(limits = symmetric_limits) +
  geom_vline(xintercept = 0, color = "grey") + geom_hline(yintercept = 0, color = "grey") +
  labs(subtitle = "SU009", x = "Median telomere content difference (post - pre)", y = "Cell count difference (post - pre) [%]", col = "T-cell subtype") +
  theme_publication +
  scale_colour_20() +
  theme(text=element_text(size=15), 
        axis.text.x = element_text(vjust = 1, hjust=1))

# generate the multipanel figure 
FIG3 = plot_grid(
  plot_grid(
    ggplot() + theme_void(),
    A3 + theme(legend.position = "none"), 
    ggplot() + theme_void(),
    B3 + theme(legend.position = "none"),
    ncol = 2, 
    align = "hv",
    labels = c("", "a", "", "b"),
    label_size = 25,
    label_x = -0.02,
    rel_widths = c(0.05,0.95)
  ),
  plot_grid(
    ggplot() + theme_void(),
    C3 + theme(legend.position = "none"), 
    get_legend(C3), 
    get_legend(A3), 
    ncol = 4, 
    rel_widths = c(0.05, 0.32, 0.31, 0.31), 
    labels = c("", "c", "", ""),
    label_size = 25,
    label_x = -0.02
  ),
  ncol = 1, align = "hv", rel_heights = c(0.8, 0.2)
)

# save the figure
ggsave(filename = "path/figure_3.pdf", plot = FIG3, units = "in", width = 15, height = 28)
ggsave(filename = "path/figure_3.png", plot = FIG3, units = "in", width = 15, height = 28)

```

# Figure 4: Association of GC-corrected telomere content to therapy response

```{r}
# create a function to display the number of observations in the individual boxplots
give.n <- function(x){
  return(c(y = median(x)*1.2, label = length(x))) 
}

# compute wilcoxon test derived q-values and effect sizes for the telomere content between responders and non-responders
pre_post_effsize_wilcox <- masterdataframe_tanno_t4 %>%
  filter(Satpathy_T_cell_annot != "No T cell") %>%
  group_by(Satpathy_T_cell_annot, pre_post_f) %>%
  wilcox_effsize(tel_content ~ responder, paired = F)

pre_post_wilcox <- masterdataframe_tanno_t4 %>%
  dplyr::filter(Satpathy_T_cell_annot != "No T cell") %>%
  group_by(Satpathy_T_cell_annot, pre_post_f) %>%
  wilcox_test(tel_content ~ responder, paired = F) %>%
  adjust_pvalue(method = "hochberg")

pre_post_wilcox_test <-  data.frame(pre_post_wilcox, pre_post_effsize_wilcox$effsize)

pre_post_wilcox_test_full <- merge(pre_post_wilcox, pre_post_effsize_wilcox, by = c("Satpathy_T_cell_annot", "pre_post_f"))

# select the bottom quantile cutoff for looking at cells with shorter telomeres
lower_quantile_cutoff <- 0.25

# compute q-values and effect sizes for the bottom quantile 
pre_post_wilcox_bottom_q <- masterdataframe_tanno_t4 %>%
  dplyr::filter(Satpathy_T_cell_annot != "No T cell") %>%
  group_by(Satpathy_T_cell_annot, pre_post_f, responder) %>%
  filter(tel_content <= quantile(tel_content, lower_quantile_cutoff)) %>%
  ungroup() %>%
  group_by(Satpathy_T_cell_annot, pre_post_f) %>%
  wilcox_test(tel_content ~ responder, paired = F) %>%
  adjust_pvalue(method = "hochberg")

pre_post_effsize_wilcox_bottom_q <- masterdataframe_tanno_t4 %>%
  filter(Satpathy_T_cell_annot != "No T cell") %>%
  group_by(Satpathy_T_cell_annot, pre_post_f, responder) %>%
  filter(tel_content <= quantile(tel_content, lower_quantile_cutoff)) %>%
  ungroup() %>%  group_by(Satpathy_T_cell_annot, pre_post_f) %>%
  wilcox_effsize(tel_content ~ responder, paired = F)

bottom_quartile_test_data <- merge(pre_post_wilcox_bottom_q, pre_post_effsize_wilcox_bottom_q, by = c("Satpathy_T_cell_annot", "pre_post_f"))

# Compute counts and median telomere contents for the bottom quartile cells
bottom_quartile_stats <- masterdataframe_tanno_t4 %>%
  dplyr::filter(Satpathy_T_cell_annot != "No T cell") %>%
  group_by(Satpathy_T_cell_annot, pre_post_f, responder) %>%
  filter(tel_content <= quantile(tel_content, lower_quantile_cutoff)) %>%
  summarise(no = n(), median = median(tel_content))

bottom_quartile_stats_data_wilcox <- merge(bottom_quartile_stats, pre_post_wilcox_bottom_q, by = c("Satpathy_T_cell_annot", "pre_post_f"))

# generate the figures 
A4 <- ggplot(masterdataframe_tanno_t4, aes(responder, tel_content, fill = responder)) +
  geom_boxplot(outlier.shape = NA) +
  scale_fill_manual(values = c("#4393C3", "#D6604D")) +  
  theme_publication +
  theme(text=element_text(size=15), axis.text.x = element_text(angle = 45, vjust = 1, hjust=1), 
        legend.position = "none") +
  facet_grid(pre_post_f ~ cell_type) +
  coord_cartesian(ylim = c(0, 15000)) +
  labs(y = "Telomere content", x = "Response", fill = "Response") +
  stat_compare_means(method = "wilcox.test", paired = FALSE, p.adjust = "hochberg", label = "p.signif", label.y = 14500, size = 7)

B4 <- ggplot(masterdataframe_tanno_t4, aes(patientID, tel_content, fill = responder)) + 
  geom_violin() +
  geom_boxplot(coef = 0, outlier.shape = NA, width = 0.25) +
  coord_cartesian(ylim = c(0,15000)) +
  stat_summary(fun.data = give.n, geom = "text", fun = sum, size = 5) +
  facet_wrap(~factor(pre_post, levels = c("pre treatment", "post treatment"))) +
  scale_fill_manual(values = c("#4393C3", "#D6604D")) +
  theme_publication +
  theme(text=element_text(size=15), axis.text.x = element_text(angle = 45, vjust = 1, hjust=1), 
        legend.position = "none") + 
  labs(y = "Telomere content", fill = "Response")

# set the significant threshold to color dots based on q-value
significance_threshold <- 0.01

C4 <- ggplot(pre_post_wilcox_test, aes(x = pre_post_effsize_wilcox.effsize, y = -log10(p))) +
  geom_point(size = 2, color = ifelse(pre_post_wilcox_test$p.adj < significance_threshold, "red", "black"), alpha = 0.6) +
  geom_text_repel(
    data = subset(pre_post_wilcox_test, p.adj < significance_threshold),
    aes(label = Satpathy_T_cell_annot),
    size = 5, color = "black",
    box.padding = 0.35, 
    point.padding = 0.3,
    max.overlaps = Inf
  ) +
  facet_wrap(~pre_post_f) +
  labs(subtitle = "all cells", x = "Wilcoxon effect size", y = "-log10 p-value") +
  theme_publication +
  theme(text=element_text(size=15),
        axis.text.x = element_text(vjust = 1, hjust=1))

D4 <- bottom_quartile_test_data %>%
  ggplot(aes(x = effsize, y = -log10(p))) +
  geom_point(size = 2, color = ifelse(bottom_quartile_test_data$p.adj < significance_threshold, "red", "black"), alpha = 0.6) +
  geom_text_repel(
    data = subset(bottom_quartile_test_data, p.adj < significance_threshold),
    aes(label = Satpathy_T_cell_annot),
    size = 5, color = "black",
    box.padding = 0.35, 
    point.padding = 0.3,
    max.overlaps = Inf
  ) +
  facet_wrap(~pre_post_f) +
  labs(subtitle = "bottom quartile", x = "Wilcoxon effect size", y = "-log10 p-value") +
  theme_publication +
  theme(text=element_text(size=15), 
        axis.text.x = element_text(vjust = 1, hjust=1))

E4 <- pre_post_wilcox_test_full %>%
  ggplot(aes(no, median, col = Satpathy_T_cell_annot, shape = responder, size = -log10(p.adj))) +
  geom_point() +
  facet_wrap(~pre_post_f) +
  theme_publication +
  theme(text=element_text(size=15), 
        axis.text.x = element_text(vjust = 1, hjust=1)) +
  labs(subtitle = "all cells", x = "No. of cells", y = "Median telomere content", col = "T-cell subtype", shape = "Response") +
  scale_colour_20()

F4 <- bottom_quartile_stats_data_wilcox %>%
  ggplot(aes(no, median, col = Satpathy_T_cell_annot, shape = responder, size = -log10(p.adj))) +
  geom_point() +
  facet_wrap(~pre_post_f) +
  theme_publication +
  theme(text=element_text(size=15), 
        legend.position = "bottom", 
        legend.box = "vertical", 
        axis.text.x = element_text(vjust = 1, hjust=1)) +
  labs(subtitle = "bottom quartile", x = "No. of cells", y = paste0("Bottom ", lower_quantile_cutoff, " quantile median telomere content"), col = "T-cell subtype", shape = "Response") +
  scale_colour_20()

# generate the multipanel figure 
FIG4 <- plot_grid(
  plot_grid(
    A4, B4, 
    C4, D4, 
    E4 + theme(legend.position = "none"), F4 + theme(legend.position = "none"), 
    ncol = 2, align = "hv", labels = c("a", "b", "c", "d", "e", "f"), label_size = 25), 
  get_legend(F4), 
  ncol = 1, rel_heights = c(0.90, 0.1))

# save the figure
ggsave(filename = "path/figure_4.pdf", plot = FIG4, units = "in", width = 18, height = 24)
ggsave(filename = "path/figure_4.png", plot = FIG4, units = "in", width = 18, height = 24)

```

# Supplement

## Tables

```{r}
# trpm the whole data set exhibits
sum(masterdataframe_tanno_t4$tel_reads)/sum(masterdataframe_tanno_t4$total_reads)*1000000

## Tables

# Suppl. Table 2
masterdataframe_thresholds %>%
  filter(threshold %in% c(0, 3, 4, 5)) %>%
  group_by(threshold) %>%
  summarise(count = n()/35139*100, median = median(tel_content), sd = sd(tel_content), zero_ratio = sum(tel_content == 0)/n()*100)

# Suppl. Table 3
masterdataframe_tanno_t4 %>%
  group_by(patientID) %>%
  summarise(n(), median(tel_content), sd(tel_content))

# Suppl. Table 4
masterdataframe_tanno_t4 %>%
  group_by(pre_post) %>%
  summarise(n(), median(tel_content), sd(tel_content))

# Suppl. Table 5
masterdataframe_tanno_t4 %>%
  group_by(responder) %>%
  summarise(n(), median(tel_content), sd(tel_content))

# Suppl. Table 6
masterdataframe_tanno_t4 %>%
  group_by(cell_type) %>%
  summarise(n(), median(tel_content), sd(tel_content))

# Suppl. Table 7
masterdataframe_tanno_t4 %>%
  group_by(Satpathy_T_cell_annot) %>%
  summarise(n(), median(tel_content), sd(tel_content))

# Suppl. Table 8
masterdataframe_tanno_t4 %>%
  filter(pre_post == "pre treatment") %>%
  group_by(responder, pre_post) %>%
  summarise(n(), median(tel_content), sd(tel_content))

# Suppl. Table 9
pre_post_wilcox_test %>%
  filter(pre_post_f == "pre treatment") %>%
  dplyr::select(Satpathy_T_cell_annot, n1, n2, p.adj, pre_post_effsize_wilcox.effsize)

# Suppl. Table 10
pre_post_wilcox_test %>%
  filter(pre_post_f == "post treatment") %>%
  dplyr::select(Satpathy_T_cell_annot, n1, n2, p.adj, pre_post_effsize_wilcox.effsize)

```

# Supplementary Figures 

# Suppl. Figure 1

```{r}
SA1 = ggplot(threshold_sums, aes(factor(Var1), percentage*100, group = 1)) +
  geom_line() +
  theme_publication +
  geom_vline(xintercept = factor(10000), color = "red") +
  labs(x = "Total reads cutoff to the power of 10", y = "Total cell ratio [%]") +
  scale_x_discrete(breaks = c(1000, 10000, 100000)) +
  theme(text=element_text(size=15), 
        axis.text.x = element_text(vjust = 1, hjust=1))

SB1 = ggplot(threshold_sums, aes(factor(Var1), sd, group = 1)) + 
  geom_line() +
  theme_publication +
  geom_vline(xintercept = factor(10000), color = "red") +
  labs(x = "Total reads cutoff to the power of 10", y = "Telomere content standard deviation") +
  scale_x_discrete(breaks = c(1000, 10000, 100000)) +
  theme(text=element_text(size=15), 
        axis.text.x = element_text(vjust = 1, hjust=1))

SC1 = ggplot(threshold_sums, aes(factor(Var1), median, group = 1)) + 
  geom_line() +
  theme_publication +
  geom_vline(xintercept = factor(10000), color = "red") +
  labs(x = "Total reads cutoff to the power of 10", y = "Telomere content median") +
  scale_x_discrete(breaks = c(1000, 10000, 100000)) +
  theme(text=element_text(size=15), 
        axis.text.x = element_text(vjust = 1, hjust=1))

# generate the multipanel figure 
SFIG1 <- plot_grid(SA1, SB1, SC1, 
          nrow = 1, labels = c("a", "b", "c"), label_size = 25, align = "hv")

# save the figure
ggsave(filename = "path/suppl_figure_1.pdf", plot = SFIG1, units = "in", width = 18, height = 6)
ggsave(filename = "path/suppl_figure_1.png", plot = SFIG1, units = "in", width = 18, height = 6)

```

# Suppl. Figure 2

```{r}
# compute the median and standard deviation telomere content for cell types, response, time and patients
threshold_cell_type_stats <- masterdataframe_thresholds %>%
  group_by(cell_type, threshold) %>%
  summarize(Median = median(tel_content), SD = sd(tel_content))

threshold_cell_type_stats$threshold <- 10^as.numeric(threshold_cell_type_stats$threshold)

threshold_response_stats <- masterdataframe_thresholds %>%
  group_by(responder, threshold) %>%
  summarize(Median = median(tel_content), SD = sd(tel_content))

threshold_response_stats$threshold <- 10^as.numeric(threshold_response_stats$threshold)

threshold_time_stats <- masterdataframe_thresholds %>%
  group_by(pre_post, threshold) %>%
  summarize(Median = median(tel_content), SD = sd(tel_content))

threshold_time_stats$threshold <- 10^as.numeric(threshold_time_stats$threshold)

threshold_patient_stats <- masterdataframe_thresholds %>%
  group_by(patientID, threshold) %>%
  summarize(Median = median(tel_content), SD = sd(tel_content))

threshold_patient_stats$threshold <- 10^as.numeric(threshold_patient_stats$threshold)

SA2 <- ggplot(threshold_response_stats, aes(factor(threshold), Median, col = factor(responder), group = responder)) +
  geom_line() +
  theme_publication +
  scale_colour_manual(values = c("#4393C3", "#D6604D")) +
  labs(col = "Response", y = "Median telomere content", x = "") +
  scale_x_discrete(labels = c("", "1000", rep("", 9), "10000", rep("", 9), "100000", rep("", 5)))

SB2 <- ggplot(threshold_time_stats, aes(factor(threshold), Median, col = factor(pre_post), group = pre_post)) +
  geom_line() +
  theme_publication +
  scale_colour_publication() +
  labs(col = "Time", y = "", x = "") +
  scale_x_discrete(labels = c("", "1000", rep("", 9), "10000", rep("", 9), "100000", rep("", 5)))

SC2 <- ggplot(threshold_cell_type_stats, aes(factor(threshold), Median, col = factor(cell_type), group = cell_type)) +
  geom_line() +
  theme_publication +
  scale_colour_publication() +
  labs(col = "Cell type", y = "Median telomere content", x = "Total reads cutoff") +
  scale_x_discrete(labels = c("", "1000", rep("", 9), "10000", rep("", 9), "100000", rep("", 5)))

SD2 <- ggplot(threshold_patient_stats, aes(factor(threshold), Median, col = factor(patientID), group = patientID)) +
  geom_line() +
  theme_publication +
  scale_colour_publication() +
  labs(col = "PatientID", y = "", x = "Total reads cutoff") +
  scale_x_discrete(labels = c("", "1000", rep("", 9), "10000", rep("", 9), "100000", rep("", 5)))

# generate the multipanel figure 
SFIG2 <- plot_grid(SA2, SB2, 
                   SC2, SD2, 
                   nrow = 2, labels = c("a", "b", "c", "d"), label_size = 25, align = "hv")

# save the figure 
ggsave(filename = "path/suppl_figure_2.pdf", plot = SFIG2, units = "in", width = 18, height = 12)
ggsave(filename = "path/suppl_figure_2.png", plot = SFIG2, units = "in", width = 18, height = 12)

```

# Suppl. Figure 3

```{r}
SA3 <- ggplot(threshold_response_stats, aes(factor(threshold), SD, col = factor(responder), group = responder)) +
  geom_line() +
  theme_publication +
  scale_colour_manual(values = c("#4393C3", "#D6604D")) +
  labs(col = "Response", y = "Standard deviation telomere content", x = "") +
  scale_x_discrete(labels = c("", "1000", rep("", 9), "10000", rep("", 9), "100000", rep("", 5)))

SB3 <- ggplot(threshold_time_stats, aes(factor(threshold), SD, col = factor(pre_post), group = pre_post)) +
  geom_line() +
  theme_publication +
  scale_colour_publication() +
  labs(col = "Time", y = "", x = "") +
  scale_x_discrete(labels = c("", "1000", rep("", 9), "10000", rep("", 9), "100000", rep("", 5)))

SC3 <- ggplot(threshold_cell_type_stats, aes(factor(threshold), SD, col = factor(cell_type), group = cell_type)) +
  geom_line() +
  theme_publication +
  scale_colour_publication() +
  labs(col = "Cell type", y = "Standard deviation telomere content", x = "Total reads cutoff") +
  scale_x_discrete(labels = c("", "1000", rep("", 9), "10000", rep("", 9), "100000", rep("", 5)))

SD3 <- ggplot(threshold_patient_stats, aes(factor(threshold), SD, col = factor(patientID), group = patientID)) +
  geom_line() +
  theme_publication +
  scale_colour_publication() +
  labs(col = "PatientID", y = "", x = "Total reads cutoff") +
  scale_x_discrete(labels = c("", "1000", rep("", 9), "10000", rep("", 9), "100000", rep("", 5)))

SE3 <- ggplot(threshold_cell_subtype_stats, aes(factor(threshold), SD, col = factor(Satpathy_T_cell_annot), group = Satpathy_T_cell_annot)) +
  geom_line() +
  theme_publication +
  scale_colour_20() +
  labs(col = "T-cell subtype", y = "Standard deviation telomere content", x = "Total reads cutoff") +
  scale_x_discrete(labels = c("", "1000", rep("", 9), "10000", rep("", 9), "100000", rep("", 5)))

# generate the multipanel figure 
SFIG3 <- plot_grid(
  plot_grid(SA3, SB3, 
            SC3, SD3, 
            nrow = 2, labels = c("a", "b", "c", "d"), label_size = 25, align = "hv"), 
  SE3, 
  nrow = 2, labels = c("", "e"), label_size = 25, align = "hv", rel_heights = c(0.66, 0.33))

# save the figure
ggsave(filename = "path/suppl_figure_3.pdf", plot = SFIG3, units = "in", width = 18, height = 18)
ggsave(filename = "path/suppl_figure_3.png", plot = SFIG3, units = "in", width = 18, height = 18)

```

# Suppl. Figure 4

```{r}
SFIG4 <- masterdataframe_tanno_t4 %>%
  ggplot(aes(patientID, tel_content, fill = patientID %in% c("SU001", "SU009"))) +
  geom_violin() +
  geom_boxplot(width = .25, outlier.shape = NA) +
  theme_publication +
  scale_y_log10() +
  scale_fill_manual(labels = c("Non-responder", "Responder"), values = c("#4393C3", "#D6604D")) +
  labs(x = "PatientID", y = "Telomere content", fill = "Response") +
  annotation_logticks(side = "l")

# save the figure
ggsave(filename = "path/suppl_figure_4.pdf", plot = SFIG4, units = "in", width = 8, height = 8)
ggsave(filename = "path/suppl_figure_4.png", plot = SFIG4, units = "in", width = 8, height = 8)

```

# Suppl. Figure 5

```{r}
ctrpm <- masterdataframe_tanno %>%
  group_by(cell_type) %>%
  summarise(a = sum(trpm >= 200 & trpm <= 1000), b = n()) %>%
  mutate(a/b * 100)
ctrpm$t <- "t0"

ctrpm4 <- masterdataframe_tanno_t4 %>%
  group_by(cell_type) %>%
  summarise(a = sum(trpm >= 200 & trpm <= 1000), b = n()) %>%
  mutate(a/b * 100)
ctrpm4$t <- "t4"

ctrpm_df <- rbind(ctrpm, ctrpm4)
colnames(ctrpm_df) <- c("cell_type", "a", "b", "trpm", "t")

SA5 = ggplot(ctrpm_df, aes(cell_type, trpm, fill = factor(t, labels = c("no threshold", "threshold 10^4")))) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = c("dodgerblue", "darkorange")) +
  labs(x = "Cell type", y = "Cells in *in vivo* validated range [%]", fill = "Threshold") +
  theme_publication +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1), 
        axis.title.y = ggtext::element_markdown(), 
        legend.position="none")


ctrpm <- masterdataframe_tanno %>%
  group_by(sampleID) %>%
  summarise(a = sum(trpm >= 200 & trpm <= 1000), b = n()) %>%
  mutate(a/b * 100)
ctrpm$t <- "t0"

ctrpm4 <- masterdataframe_tanno_t4 %>%
  group_by(sampleID) %>%
  summarise(a = sum(trpm >= 200 & trpm <= 1000), b = n()) %>%
  mutate(a/b * 100)
ctrpm4$t <- "t4"

ctrpm_df <- rbind(ctrpm, ctrpm4)
colnames(ctrpm_df) <- c("sampleID", "a", "b", "trpm", "t")

SB5 = ggplot(ctrpm_df, aes(sampleID, trpm, fill = factor(t, labels = c("no threshold", "threshold 10^4")))) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = c("dodgerblue", "darkorange")) +
  labs(x = "SampleID", y = "", fill = "Threshold") +
  theme_publication +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1), 
        axis.title.y = ggtext::element_markdown(), 
        legend.position="none")

ctrpm <- masterdataframe_tanno %>%
  group_by(Satpathy_T_cell_annot) %>%
  summarise(a = sum(trpm >= 200 & trpm <= 1000), b = n()) %>%
  mutate(a/b * 100)
ctrpm$t <- "t0"

ctrpm4 <- masterdataframe_tanno_t4 %>%
  group_by(Satpathy_T_cell_annot) %>%
  summarise(a = sum(trpm >= 200 & trpm <= 1000), b = n()) %>%
  mutate(a/b * 100)
ctrpm4$t <- "t4"

ctrpm_df <- rbind(ctrpm, ctrpm4)
colnames(ctrpm_df) <- c("Satpathy_T_cell_annot", "a", "b", "trpm", "t")

SC5 = ggplot(ctrpm_df, aes(Satpathy_T_cell_annot, trpm, fill = factor(t, labels = c("no threshold", "threshold 10^4")))) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = c("dodgerblue", "darkorange")) +
  labs(x = "T-cell subtype", y = "", fill = "Threshold") +
  theme_publication +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust=1), 
        axis.title.y = ggtext::element_markdown())

# generate the multipanel figure 
SFIG5 <- plot_grid(SA5, SB5, SC5,
                  nrow = 1, labels = c("a", "b", "c"), label_size = 25, align = "h", rel_widths = c(0.2, 0.4, 0.4))

# save the figure
ggsave(filename = "path/suppl_figure_5.pdf", plot = SFIG5, units = "in", width = 16, height = 8)
ggsave(filename = "path/suppl_figure_5.png", plot = SFIG5, units = "in", width = 16, height = 8)

```

# Suppl. Figure 6

```{r}
SA6 <- masterdataframe_tanno_t4_umap_rounded_stats %>%
  ggplot(aes(umap1, umap2, col = median_tel)) +
  geom_point() +
  facet_grid(pre_post_f~responder) +
  scale_color_viridis(option = "plasma", limits = c(0, 25000), oob = scales::squish) +
  labs(subtitle = "Median telomere content per averaged UMAP coordinate", col = "Telomere content") +
  theme_publication +
  theme(legend.position = "none",
        text=element_text(size=15),
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background =element_rect(fill="white"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank(),
        panel.border = element_blank()
        )

SB6 <- masterdataframe_tanno_t4_umap_rounded_stats %>%
  ggplot(aes(umap1, umap2, col = max_tel)) +
  geom_point() +
  facet_grid(pre_post_f~responder) +
  scale_color_viridis(option = "plasma", limits = c(0, 25000), oob = scales::squish) +
  labs(subtitle = "Maximum telomere content per averaged UMAP coordinate", col = "Telomere content") +
  theme_publication +
  theme(legend.position = "bottom",
        text=element_text(size=15),
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background =element_rect(fill="white"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank(),
        panel.border = element_blank()
        ) +
  guides(colour = guide_colourbar(
    label.hjust = 0,
    label.vjust = 0.25,
    label.theme = element_text(angle = 90, size = 15)
  ))


SC6 <- masterdataframe_tanno_t4_umap_rounded_stats %>%
  ggplot(aes(umap1, umap2, col = min_tel)) +
  geom_point() +
  facet_grid(pre_post_f~responder) +
  scale_color_viridis(option = "plasma", limits = c(0, 25000), oob = scales::squish) +
  labs(subtitle = "Minimum telomere content per averaged UMAP coordinate", col = "Telomere content") +
  theme_publication +
  theme(legend.position = "bottom",
        text=element_text(size=15),
        plot.background = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        strip.background =element_rect(fill="white"),
        axis.title.x = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks = element_blank(),
        axis.line = element_blank(),
        panel.border = element_blank()
        ) +
  guides(colour = guide_colourbar(
    label.hjust = 0,
    label.vjust = 0.25,
    label.theme = element_text(angle = 90, size = 15)
  ))

# generate the multipanel figure 
SFIG6_1 <- plot_grid(
    ggplot() + theme_void(),
    SA6, 
    ggplot() + theme_void(),
    SB6,
    ncol = 2, 
    align = "hv",
    labels = c("", "a", "", "b"),
    label_size = 25,
    label_x = -0.02,
    rel_widths = c(0.05,0.95)
  )

SFIG6_2 <- plot_grid(
    ggplot() + theme_void(),
    SC6,
    ncol = 2,
    labels = c("", "c"),
    label_size = 25,
    label_x = -0.02,
    rel_widths = c(0.05,0.95)
  )

# save the figure
ggsave(filename = "path/suppl_figure_6.1.pdf", plot = SFIG6_1, units = "in", width = 14, height = 24)
ggsave(filename = "path/suppl_figure_6.1.png", plot = SFIG6_1, units = "in", width = 14, height = 24)
ggsave(filename = "path/suppl_figure_6.2.pdf", plot = SFIG6_2, units = "in", width = 14, height = 12)
ggsave(filename = "path/suppl_figure_6.2.png", plot = SFIG6_2, units = "in", width = 14, height = 12)

```

# Suppl. Figure 7

```{r}
SA7 = ggplot(subset(diff_data, Satpathy_T_cell_annot != "No T cell"), aes(patientID, count_diff_normalized, fill = patientID %in% c("SU001", "SU009")))+
  geom_col(position = "dodge") +
  facet_wrap(~Satpathy_T_cell_annot) +
  scale_fill_manual(labels = c("Non-responder", "Responder"), values = c("#4393C3", "#D6604D")) +
  geom_hline(yintercept = 0, color = "grey") +
  labs(x = "PatientID", y = "Normalized cell count difference (post - pre)", fill = "Response") +
  theme_publication +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1), 
        text=element_text(size=15))

SB7 = ggplot(subset(diff_data, Satpathy_T_cell_annot != "No T cell"), aes(tel_diff, count_diff_normalized, col = patientID %in% c("SU001", "SU009"), shape = patientID)) +
  geom_point() +
  facet_wrap(~Satpathy_T_cell_annot) +
  scale_x_continuous(limits = symmetric_limits) +
  scale_y_continuous(limits = symmetric_limits) +
  scale_color_manual(labels = c("Non-responder", "Responder"), values = c("#4393C3", "#D6604D")) +
  scale_shape_manual(values=c(1,2,3,4,6,7,8)) +
  geom_vline(xintercept = 0, color = "grey") + geom_hline(yintercept = 0, color = "grey") +
  labs(x = "Median telomere content difference (post - pre)", y = "Normalized cell count difference (post - pre)", col = "Response", shape = "PatientID") +
  theme_publication +
  theme(text=element_text(size=15),
        axis.text.x = element_text(vjust = 1, hjust=1))

# generate the multipanel figure 
SFIG7 <- plot_grid(
  SA7, SB7, 
  ncol = 1, labels = c("a", "b"), label_size = 25, align = "hv"
)

# save the figure
ggsave(filename = "path/suppl_figure_7.pdf", plot = SFIG7, units = "in", width = 18, height = 24)
ggsave(filename = "path/suppl_figure_7.png", plot = SFIG7, units = "in", width = 18, height = 24)

```

# Suppl. Figure 8

```{r}
SFIG8 <- ggplot(subset(diff_data, patientID %in% c("SU001", "SU006", "SU008", "SU009", "SU010")), aes(tel_diff, count_diff_percentage, col = Satpathy_T_cell_annot)) +
  geom_point(size = 3) +
  scale_x_continuous(limits = symmetric_limits) +
  scale_y_continuous(limits = symmetric_limits) +
  geom_vline(xintercept = 0, color = "grey") + geom_hline(yintercept = 0, color = "grey") +
  labs(x = "Median telomere content difference (post - pre)", y = "Cell count difference (post - pre) [%]", col = "T-cell subtype") +
  facet_wrap(~patientID, scales = "free") +
  theme_publication +
  theme(text=element_text(size=15), 
        axis.text.x = element_text(vjust = 1, hjust=1)) +
  scale_colour_20()

# save the figure
ggsave(filename = "path/suppl_figure_8.pdf", plot = SFIG8, units = "in", width = 16, height = 10)
ggsave(filename = "path/suppl_figure_8.png", plot = SFIG8, units = "in", width = 16, height = 10)

```

# Suppl. Figure 9

```{r}
SFIG9 <- ggplot(masterdataframe_tanno_t4, aes(patientID, tel_content, fill = responder)) + 
  geom_violin() +
  geom_boxplot(coef = 0, outlier.shape = NA, width = 0.25) +
  stat_summary(fun.data = give.n, geom = "text", fun = sum, size = 5) +
  facet_wrap(~factor(pre_post, levels = c("pre treatment", "post treatment"))) +
  scale_fill_manual(values = c("#4393C3", "#D6604D")) +
  scale_y_log10() +
  theme_publication +
  theme(text=element_text(size=15), 
        axis.text.x = element_text(angle = 45, vjust = 1, hjust=1), 
        legend.position = "none") +
  labs(x = "PatientID", y = "Telomere content", fill = "Response")

# save the figure
ggsave(filename = "path/suppl_figure_9.pdf", plot = SFIG9, units = "in", width = 10, height = 8)
ggsave(filename = "path/suppl_figure_9.png", plot = SFIG9, units = "in", width = 10, height = 8)

```

# Suppl. Figure 10

```{r}
satpathy_celltype_effsize <- wilcox_effsize(masterdataframe_tanno_t4, tel_content ~ cell_type, paired = FALSE)
satpathy_celltype_wilcoxon <- pairwise_wilcox_test(masterdataframe_tanno_t4, tel_content ~ cell_type, p.adjust.method = "hochberg", paired = FALSE)
satpathy_celltype_wilcoxon_effsize <- merge(satpathy_celltype_wilcoxon, satpathy_celltype_effsize, by = c("group1", "group2"))

SA10 <- ggplot(satpathy_celltype_wilcoxon_effsize) + 
  geom_tile(aes(x = group2, y = group1, fill = p.adj), color = "black") +
  geom_point(aes(x = group2, y = group1, size = abs(effsize))) + 
  geom_text(aes(x = group2, y = group1, label = round(p.adj, 2)), color = "black", vjust = 2.5, size = 3) +
  labs(x = "Cell type 1", y = "Cell type 2", fill = "q-value", size = "Effect size") +
  scale_fill_gradient(low = "white", high = "#386cb0", na.value = "black") +
  theme_publication +
    theme(axis.text.x = element_text(vjust = 1, hjust=1))

satpathy_subtype_effsize <- wilcox_effsize(masterdataframe_tanno_t4, tel_content ~ Satpathy_T_cell_annot, paired = FALSE)
satpathy_subtype_wilcoxon <- pairwise_wilcox_test(masterdataframe_tanno_t4, tel_content ~ Satpathy_T_cell_annot, p.adjust.method = "hochberg", paired = FALSE)
satpathy_subtype_wilcoxon_effsize <- merge(satpathy_subtype_wilcoxon, satpathy_subtype_effsize, by = c("group1", "group2"))

SB10 <- ggplot(satpathy_subtype_wilcoxon_effsize) + 
  geom_tile(aes(x = group2, y = group1, fill = p.adj), color = "black") +
  geom_point(aes(x = group2, y = group1, size = abs(effsize))) + 
  geom_text(aes(x = group2, y = group1, label = round(p.adj, 2)), color = "black", vjust = 2, size = 3) +
  labs(x = "T-cell subtype 1", y = "T-cell subtype 2", fill = "q-value", size = "Effect size") +
  scale_fill_gradient(low = "white", high = "#386cb0", na.value = "black") +
  theme_publication +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))

satpathy_patient_effsize <- wilcox_effsize(masterdataframe_tanno_t4, tel_content ~ patientID, paired = FALSE)
satpathy_patient_wilcoxon <- pairwise_wilcox_test(masterdataframe_tanno_t4, tel_content ~ patientID, p.adjust.method = "hochberg", paired = FALSE)
satpathy_patient_wilcoxon_effsize <- merge(satpathy_patient_wilcoxon, satpathy_patient_effsize, by = c("group1", "group2"))

SC10 <- ggplot(satpathy_patient_wilcoxon_effsize) + 
  geom_tile(aes(x = group2, y = group1, fill = p.adj), color = "black") +
  geom_point(aes(x = group2, y = group1, size = abs(effsize))) + 
  geom_text(aes(x = group2, y = group1, label = round(p.adj, 2)), color = "black", vjust = 2.5, size = 3) +
  labs(x = "PatientID 1", y = "PatientID 2", fill = "q-value", size = "Effect size") +
  scale_fill_gradient(low = "white", high = "#386cb0", na.value = "black") +
  theme_publication +
    theme(axis.text.x = element_text(vjust = 1, hjust=1))

# generate the multipanel figure 
SFIG10 <- plot_grid(
  plot_grid(
    SA10, SC10, 
    ncol = 1, labels = c("a", "c"), label_size = 25, align = "hv"), 
  SB10, 
  labels = c("", "b"), label_size = 25, align = "hv", nrow = 1, rel_widths = c(0.45, 0.55))

# save the figure
ggsave(filename = "path/suppl_figure_10.pdf", plot = SFIG10, units = "in", width = 18, height = 10)
ggsave(filename = "path/suppl_figure_10.png", plot = SFIG10, units = "in", width = 18, height = 10)

```

# Suppl. Figure 11

```{r}
# create a data frame to generate craviola plots
df_pre <-  subset(masterdataframe_tanno_t4, pre_post == "pre treatment")
craviola_data_pre <- data.frame(
  Samples = paste(df_pre$Satpathy_T_cell_annot, df_pre$responder),
  Groups = df_pre$Satpathy_T_cell_annot,
  Conditions = df_pre$responder,
  Values = df_pre$tel_content,
  Seq_depth = df_pre$seq_depth)

df_post <-  subset(masterdataframe_tanno_t4, pre_post == "post treatment")
craviola_data_post <- data.frame(
  Samples = paste(df_post$Satpathy_T_cell_annot, df_post$responder),
  Groups = df_post$Satpathy_T_cell_annot,
  Conditions = df_post$responder,
  Values = df_post$tel_content,
  Seq_depth = df_post$seq_depth)

craviola_data_all <- rbind(subset(craviola_data_pre, Groups %in% c("Intermediate TEx", "Terminal TEx")), subset(craviola_data_post, Groups %in% c("Early TEx")))

craviola_data_pre$Samples <- NULL
SA11 <- ggcraviola(data = subset(craviola_data_pre, Seq_depth >= 4), 
                               lines.col = "black", 
                               mean.value = FALSE) +
  theme_publication +
  scale_fill_manual(labels = c("Non-responder", "Responder"), values = c("#4393C3", "#D6604D")) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(x = "T-cell subtype", 
       y = "Telomere content", 
       fill = "Response") +
    theme(axis.text.x = element_text(vjust = 1, hjust=1))

craviola_data_post$Samples <- NULL
SB11 <- ggcraviola(data = subset(craviola_data_post, Seq_depth >= 4), 
                                lines.col = "black", 
                                mean.value = FALSE) +
  theme_publication +
  scale_fill_manual(labels = c("Non-responder", "Responder"), values = c("#4393C3", "#D6604D")) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  labs(x = "T cell subtype", 
       y = "Telomere content", 
       fill = "Response") +
    theme(axis.text.x = element_text(vjust = 1, hjust=1, size = 15))

# generate the multipanel figure 
SFIG11 <- plot_grid(
  SA11, SB11, 
  ncol = 1, labels = c("a", "b"), label_size = 25, align = "hv")

# save the figure
ggsave(filename = "path/suppl_figure_11.pdf", plot = SFIG11, units = "in", width = 18, height = 16)
ggsave(filename = "path/suppl_figure_11.png", plot = SFIG11, units = "in", width = 18, height = 16)

```

# Suppl. Figure 12

```{r}
merged_data <- merge(masterdataframe_tanno_t4, normalized_counts, by = c("patientID", "Satpathy_T_cell_annot", "pre_post"))

SA12 <- ggplot(subset(merged_data, pre_post == "pre treatment"), aes(patientID, tel_content, fill = responder)) +
  geom_boxplot() +
  coord_cartesian(ylim = c(0, 10000)) +
  facet_wrap(~Satpathy_T_cell_annot) +
  labs(x = "PatientID", y = "Telomere content", fill = "Reponse") +
  theme_publication +
  scale_fill_manual(labels = c("Non-responder", "Responder"), values = c("#4393C3", "#D6604D")) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  geom_text(data = merged_data %>% dplyr::filter(pre_post == "pre treatment") %>% group_by(patientID, Satpathy_T_cell_annot) %>% summarise(y = median(tel_content), Time = first(normalized_count), responder = responder),
            aes(y = y,label = round(Time, 2)), 
            position = position_dodge(width = 1), 
            vjust = -0.5, 
            size = 4, 
            stat = "unique", 
            parse = TRUE
  ) +
    theme(axis.text.x = element_text(vjust = 1, hjust=1))

SB12 <- ggplot(subset(merged_data, pre_post == "post treatment"), aes(patientID, tel_content, fill = responder)) +
  geom_boxplot() +
  coord_cartesian(ylim = c(0, 10000)) +
  facet_wrap(~Satpathy_T_cell_annot) +
  labs(x = "PatientID", y = "Telomere content", fill = "Reponse") +
  theme_publication +
  scale_fill_manual(labels = c("Non-responder", "Responder"), values = c("#4393C3", "#D6604D")) +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1)) +
  geom_text(data = merged_data %>% dplyr::filter(pre_post == "post treatment") %>% group_by(patientID, Satpathy_T_cell_annot) %>% summarise(y = median(tel_content), Time = first(normalized_count), responder = responder),
            aes(y = y,label = round(Time, 2)), 
            position = position_dodge(width = 1), 
            vjust = -0.5, 
            size = 4, 
            stat = "unique", 
            parse = TRUE
  ) +
    theme(axis.text.x = element_text(vjust = 1, hjust=1))

# generate the multipanel figure 
SFIG12 <- plot_grid(SA12, SB12, ncol = 1, labels = c("a", "b"), label_size = 25, align = "hv")

# save the figure
ggsave(filename = "path/suppl_figure_12.pdf", plot = SFIG12, units = "in", width = 18, height = 16)
ggsave(filename = "path/suppl_figure_12.png", plot = SFIG12, units = "in", width = 18, height = 16)

```
